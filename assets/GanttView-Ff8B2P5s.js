import{r as L,j as b}from"./index-BSUL8Hu_.js";const U="year",Q="month",K="day",J="hour",Z="minute",tt="second",lt="millisecond",c={parse_duration(n){const t=/([0-9]+)(y|m|d|h|min|s|ms)/gm.exec(n);if(t!==null){if(t[2]==="y")return{duration:parseInt(t[1]),scale:"year"};if(t[2]==="m")return{duration:parseInt(t[1]),scale:"month"};if(t[2]==="d")return{duration:parseInt(t[1]),scale:"day"};if(t[2]==="h")return{duration:parseInt(t[1]),scale:"hour"};if(t[2]==="min")return{duration:parseInt(t[1]),scale:"minute"};if(t[2]==="s")return{duration:parseInt(t[1]),scale:"second"};if(t[2]==="ms")return{duration:parseInt(t[1]),scale:"millisecond"}}},parse(n,t="-",e=/[.:]/){if(n instanceof Date)return n;if(typeof n=="string"){let s,i;const a=n.split(" ");s=a[0].split(t).map(r=>parseInt(r,10)),i=a[1]&&a[1].split(e),s[1]=s[1]?s[1]-1:0;let o=s;return i&&i.length&&(i.length===4&&(i[3]="0."+i[3],i[3]=parseFloat(i[3])*1e3),o=o.concat(i)),new Date(...o)}},to_string(n,t=!1){if(!(n instanceof Date))throw new TypeError("Invalid argument type");const e=this.get_date_values(n).map((a,o)=>(o===1&&(a=a+1),o===6?G(a+"",3,"0"):G(a+"",2,"0"))),s=`${e[0]}-${e[1]}-${e[2]}`,i=`${e[3]}:${e[4]}:${e[5]}.${e[6]}`;return s+(t?" "+i:"")},format(n,t="YYYY-MM-DD HH:mm:ss.SSS",e="en"){const s=new Intl.DateTimeFormat(e,{month:"long"}),i=new Intl.DateTimeFormat(e,{month:"short"}),a=s.format(n),o=a.charAt(0).toUpperCase()+a.slice(1),r=this.get_date_values(n).map(l=>G(l,2,0)),h={YYYY:r[0],MM:G(+r[1]+1,2,0),DD:r[2],HH:r[3],mm:r[4],ss:r[5],SSS:r[6],D:r[2],MMMM:o,MMM:i.format(n)};let d=t;const g=[];return Object.keys(h).sort((l,_)=>_.length-l.length).forEach(l=>{d.includes(l)&&(d=d.replaceAll(l,`$${g.length}`),g.push(h[l]))}),g.forEach((l,_)=>{d=d.replaceAll(`$${_}`,l)}),d},diff(n,t,e="day"){let s,i,a,o,r,h,d;s=n-t+(t.getTimezoneOffset()-n.getTimezoneOffset())*6e4,i=s/1e3,o=i/60,a=o/60,r=a/24;let g=n.getFullYear()-t.getFullYear(),l=n.getMonth()-t.getMonth();return l+=r%30/30,h=g*12+l,n.getDate()<t.getDate()&&h--,d=h/12,e.endsWith("s")||(e+="s"),Math.round({milliseconds:s,seconds:i,minutes:o,hours:a,days:r,months:h,years:d}[e]*100)/100},today(){const n=this.get_date_values(new Date).slice(0,3);return new Date(...n)},now(){return new Date},add(n,t,e){t=parseInt(t,10);const s=[n.getFullYear()+(e===U?t:0),n.getMonth()+(e===Q?t:0),n.getDate()+(e===K?t:0),n.getHours()+(e===J?t:0),n.getMinutes()+(e===Z?t:0),n.getSeconds()+(e===tt?t:0),n.getMilliseconds()+(e===lt?t:0)];return new Date(...s)},start_of(n,t){const e={[U]:6,[Q]:5,[K]:4,[J]:3,[Z]:2,[tt]:1,[lt]:0};function s(a){const o=e[t];return e[a]<=o}const i=[n.getFullYear(),s(U)?0:n.getMonth(),s(Q)?1:n.getDate(),s(K)?0:n.getHours(),s(J)?0:n.getMinutes(),s(Z)?0:n.getSeconds(),s(tt)?0:n.getMilliseconds()];return new Date(...i)},clone(n){return new Date(...this.get_date_values(n))},get_date_values(n){return[n.getFullYear(),n.getMonth(),n.getDate(),n.getHours(),n.getMinutes(),n.getSeconds(),n.getMilliseconds()]},convert_scales(n,t){const e={millisecond:11574074074074074e-24,second:11574074074074073e-21,minute:.0006944444444444445,hour:.041666666666666664,day:1,month:30,year:365},{duration:s,scale:i}=this.parse_duration(n);return s*e[i]/e[t]},get_days_in_month(n){const t=[31,28,31,30,31,30,31,31,30,31,30,31],e=n.getMonth();if(e!==1)return t[e];const s=n.getFullYear();return s%4===0&&s%100!=0||s%400===0?29:28},get_days_in_year(n){return n.getFullYear()%4?365:366}};function G(n,t,e){return n=n+"",t=t>>0,e=String(typeof e<"u"?e:" "),n.length>t?String(n):(t=t-n.length,t>e.length&&(e+=e.repeat(t/e.length)),e.slice(0,t)+String(n))}function f(n,t){return typeof n=="string"?(t||document).querySelector(n):n||null}function x(n,t){const e=document.createElementNS("http://www.w3.org/2000/svg",n);for(let s in t)s==="append_to"?t.append_to.appendChild(e):s==="innerHTML"?e.innerHTML=t.innerHTML:s==="clipPath"?e.setAttribute("clip-path","url(#"+t[s]+")"):e.setAttribute(s,t[s]);return e}function et(n,t,e,s){const i=xt(n,t,e,s);if(i===n){const a=document.createEvent("HTMLEvents");a.initEvent("click",!0,!0),a.eventName="click",i.dispatchEvent(a)}}function xt(n,t,e,s,i="0.4s",a="0.1s"){const o=n.querySelector("animate");if(o)return f.attr(o,{attributeName:t,from:e,to:s,dur:i,begin:"click + "+a}),n;const r=x("animate",{attributeName:t,from:e,to:s,dur:i,begin:a,calcMode:"spline",values:e+";"+s,keyTimes:"0; 1",keySplines:yt("ease-out")});return n.appendChild(r),n}function yt(n){return{ease:".25 .1 .25 1",linear:"0 0 1 1","ease-in":".42 0 1 1","ease-out":"0 0 .58 1","ease-in-out":".42 0 .58 1"}[n]}f.on=(n,t,e,s)=>{s?f.delegate(n,t,e,s):(s=e,f.bind(n,t,s))};f.off=(n,t,e)=>{n.removeEventListener(t,e)};f.bind=(n,t,e)=>{t.split(/\s+/).forEach(function(s){n.addEventListener(s,e)})};f.delegate=(n,t,e,s)=>{n.addEventListener(t,function(i){const a=i.target.closest(e);a&&(i.delegatedTarget=a,s.call(this,i,a))})};f.closest=(n,t)=>t?t.matches(n)?t:f.closest(n,t.parentNode):null;f.attr=(n,t,e)=>{if(!e&&typeof t=="string")return n.getAttribute(t);if(typeof t=="object"){for(let s in t)f.attr(n,s,t[s]);return}n.setAttribute(t,e)};class vt{constructor(t,e,s){this.gantt=t,this.from_task=e,this.to_task=s,this.calculate_path(),this.draw()}calculate_path(){let t=this.from_task.$bar.getX()+this.from_task.$bar.getWidth()/2;const e=()=>this.to_task.$bar.getX()<t+this.gantt.options.padding&&t>this.from_task.$bar.getX()+this.gantt.options.padding;for(;e();)t-=10;t-=10;let s=this.gantt.config.header_height+this.gantt.options.bar_height+(this.gantt.options.padding+this.gantt.options.bar_height)*this.from_task.task._index+this.gantt.options.padding/2,i=this.to_task.$bar.getX()-13,a=this.gantt.config.header_height+this.gantt.options.bar_height/2+(this.gantt.options.padding+this.gantt.options.bar_height)*this.to_task.task._index+this.gantt.options.padding/2;const o=this.from_task.task._index>this.to_task.task._index;let r=this.gantt.options.arrow_curve;const h=o?1:0;let d=o?-r:r;if(this.to_task.$bar.getX()<=this.from_task.$bar.getX()+this.gantt.options.padding){let g=this.gantt.options.padding/2-r;g<0&&(g=0,r=this.gantt.options.padding/2,d=o?-r:r);const l=this.to_task.$bar.getY()+this.to_task.$bar.getHeight()/2-d,_=this.to_task.$bar.getX()-this.gantt.options.padding;this.path=`
                M ${t} ${s}
                v ${g}
                a ${r} ${r} 0 0 1 ${-r} ${r}
                H ${_}
                a ${r} ${r} 0 0 ${h} ${-r} ${d}
                V ${l}
                a ${r} ${r} 0 0 ${h} ${r} ${d}
                L ${i} ${a}
                m -5 -5
                l 5 5
                l -5 5`}else{i<t+r&&(r=i-t);let g=o?a+r:a-r;this.path=`
              M ${t} ${s}
              V ${g}
              a ${r} ${r} 0 0 ${h} ${r} ${r}
              L ${i} ${a}
              m -5 -5
              l 5 5
              l -5 5`}}draw(){this.element=x("path",{d:this.path,"data-from":this.from_task.task.id,"data-to":this.to_task.task.id})}update(){this.calculate_path(),this.element.setAttribute("d",this.path)}}class $t{constructor(t,e){this.set_defaults(t,e),this.prepare_wrappers(),this.prepare_helpers(),this.refresh()}refresh(){this.bar_group.innerHTML="",this.handle_group.innerHTML="",this.task.custom_class?this.group.classList.add(this.task.custom_class):this.group.classList=["bar-wrapper"],this.prepare_values(),this.draw(),this.bind()}set_defaults(t,e){this.action_completed=!1,this.gantt=t,this.task=e,this.name=this.name||""}prepare_wrappers(){this.group=x("g",{class:"bar-wrapper"+(this.task.custom_class?" "+this.task.custom_class:""),"data-id":this.task.id}),this.bar_group=x("g",{class:"bar-group",append_to:this.group}),this.handle_group=x("g",{class:"handle-group",append_to:this.group})}prepare_values(){this.invalid=this.task.invalid,this.height=this.gantt.options.bar_height,this.image_size=this.height-5,this.task._start=new Date(this.task.start),this.task._end=new Date(this.task.end),this.compute_x(),this.compute_y(),this.compute_duration(),this.corner_radius=this.gantt.options.bar_corner_radius,this.width=this.gantt.config.column_width*this.duration,(!this.task.progress||this.task.progress<0)&&(this.task.progress=0),this.task.progress>100&&(this.task.progress=100)}prepare_helpers(){SVGElement.prototype.getX=function(){return+this.getAttribute("x")},SVGElement.prototype.getY=function(){return+this.getAttribute("y")},SVGElement.prototype.getWidth=function(){return+this.getAttribute("width")},SVGElement.prototype.getHeight=function(){return+this.getAttribute("height")},SVGElement.prototype.getEndX=function(){return this.getX()+this.getWidth()}}prepare_expected_progress_values(){this.compute_expected_progress(),this.expected_progress_width=this.gantt.options.column_width*this.duration*(this.expected_progress/100)||0}draw(){this.draw_bar(),this.draw_progress_bar(),this.gantt.options.show_expected_progress&&(this.prepare_expected_progress_values(),this.draw_expected_progress_bar()),this.draw_label(),this.draw_resize_handles(),this.task.thumbnail&&this.draw_thumbnail()}draw_bar(){this.$bar=x("rect",{x:this.x,y:this.y,width:this.width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar",append_to:this.bar_group}),this.task.color&&(this.$bar.style.fill=this.task.color),et(this.$bar,"width",0,this.width),this.invalid&&this.$bar.classList.add("bar-invalid")}draw_expected_progress_bar(){this.invalid||(this.$expected_bar_progress=x("rect",{x:this.x,y:this.y,width:this.expected_progress_width,height:this.height,rx:this.corner_radius,ry:this.corner_radius,class:"bar-expected-progress",append_to:this.bar_group}),et(this.$expected_bar_progress,"width",0,this.expected_progress_width))}draw_progress_bar(){if(this.invalid)return;this.progress_width=this.calculate_progress_width();let t=this.corner_radius;/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||(t=this.corner_radius+2),this.$bar_progress=x("rect",{x:this.x,y:this.y,width:this.progress_width,height:this.height,rx:t,ry:t,class:"bar-progress",append_to:this.bar_group}),this.task.color_progress&&(this.$bar_progress.style.fill=this.task.color_progress);const e=c.diff(this.task._start,this.gantt.gantt_start,this.gantt.config.unit)/this.gantt.config.step*this.gantt.config.column_width;let s=this.gantt.create_el({classes:`date-range-highlight hide highlight-${this.task.id}`,width:this.width,left:e});this.$date_highlight=s,this.gantt.$lower_header.prepend(this.$date_highlight),et(this.$bar_progress,"width",0,this.progress_width)}calculate_progress_width(){const t=this.$bar.getWidth(),e=this.x+t,s=this.gantt.config.ignored_positions.reduce((h,d)=>h+(d>=this.x&&d<e),0)*this.gantt.config.column_width;let i=(t-s)*this.task.progress/100;const a=this.x+i,o=this.gantt.config.ignored_positions.reduce((h,d)=>h+(d>=this.x&&d<a),0)*this.gantt.config.column_width;i+=o;let r=this.gantt.get_ignored_region(this.x+i);for(;r.length;)i+=this.gantt.config.column_width,r=this.gantt.get_ignored_region(this.x+i);return this.progress_width=i,i}draw_label(){let t=this.x+this.$bar.getWidth()/2;this.task.thumbnail&&(t=this.x+this.image_size+5),x("text",{x:t,y:this.y+this.height/2,innerHTML:this.task.name,class:"bar-label",append_to:this.bar_group}),requestAnimationFrame(()=>this.update_label_position())}draw_thumbnail(){let t=10,e=2,s,i;s=x("defs",{append_to:this.bar_group}),x("rect",{id:"rect_"+this.task.id,x:this.x+t,y:this.y+e,width:this.image_size,height:this.image_size,rx:"15",class:"img_mask",append_to:s}),i=x("clipPath",{id:"clip_"+this.task.id,append_to:s}),x("use",{href:"#rect_"+this.task.id,append_to:i}),x("image",{x:this.x+t,y:this.y+e,width:this.image_size,height:this.image_size,class:"bar-img",href:this.task.thumbnail,clipPath:"clip_"+this.task.id,append_to:this.bar_group})}draw_resize_handles(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar,e=3;if(this.handles=[],this.gantt.options.readonly_dates||(this.handles.push(x("rect",{x:t.getEndX()-e/2,y:t.getY()+this.height/4,width:e,height:this.height/2,rx:2,ry:2,class:"handle right",append_to:this.handle_group})),this.handles.push(x("rect",{x:t.getX()-e/2,y:t.getY()+this.height/4,width:e,height:this.height/2,rx:2,ry:2,class:"handle left",append_to:this.handle_group}))),!this.gantt.options.readonly_progress){const s=this.$bar_progress;this.$handle_progress=x("circle",{cx:s.getEndX(),cy:s.getY()+s.getHeight()/2,r:4.5,class:"handle progress",append_to:this.handle_group}),this.handles.push(this.$handle_progress)}for(let s of this.handles)f.on(s,"mouseenter",()=>s.classList.add("active")),f.on(s,"mouseleave",()=>s.classList.remove("active"))}bind(){this.invalid||this.setup_click_event()}setup_click_event(){let t=this.task.id;f.on(this.group,"mouseover",i=>{this.gantt.trigger_event("hover",[this.task,i.screenX,i.screenY,i])}),this.gantt.options.popup_on==="click"&&f.on(this.group,"mouseup",i=>{const a=i.offsetX||i.layerX;if(this.$handle_progress){const o=+this.$handle_progress.getAttribute("cx");if(o>a-1&&o<a+1||this.gantt.bar_being_dragged)return}this.gantt.show_popup({x:i.offsetX||i.layerX,y:i.offsetY||i.layerY,task:this.task,target:this.$bar})});let e;f.on(this.group,"mouseenter",i=>{e=setTimeout(()=>{this.gantt.options.popup_on==="hover"&&this.gantt.show_popup({x:i.offsetX||i.layerX,y:i.offsetY||i.layerY,task:this.task,target:this.$bar}),this.gantt.$container.querySelector(`.highlight-${t}`).classList.remove("hide")},200)}),f.on(this.group,"mouseleave",()=>{var i,a;clearTimeout(e),this.gantt.options.popup_on==="hover"&&((a=(i=this.gantt.popup)==null?void 0:i.hide)==null||a.call(i)),this.gantt.$container.querySelector(`.highlight-${t}`).classList.add("hide")}),f.on(this.group,"click",()=>{this.gantt.trigger_event("click",[this.task])}),f.on(this.group,"dblclick",i=>{this.action_completed||(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))});let s=!1;f.on(this.group,"touchstart",i=>{if(!s)return s=!0,setTimeout(function(){s=!1},300),!1;i.preventDefault(),!this.action_completed&&(this.group.classList.remove("active"),this.gantt.popup&&this.gantt.popup.parent.classList.remove("hide"),this.gantt.trigger_event("double_click",[this.task]))})}update_bar_position({x:t=null,width:e=null}){const s=this.$bar;if(t){if(!this.task.dependencies.map(i=>this.gantt.get_bar(i).$bar.getX()).reduce((i,a)=>i&&t>=a,!0))return;this.update_attr(s,"x",t),this.x=t,this.$date_highlight.style.left=t+"px"}e>0&&(this.update_attr(s,"width",e),this.$date_highlight.style.width=e+"px"),this.update_label_position(),this.update_handle_position(),this.date_changed(),this.compute_duration(),this.gantt.options.show_expected_progress&&this.update_expected_progressbar_position(),this.update_progressbar_position(),this.update_arrow_position()}update_label_position_on_horizontal_scroll({x:t,sx:e}){const s=this.gantt.$container,i=this.group.querySelector(".bar-label"),a=this.group.querySelector(".bar-img")||"",o=this.bar_group.querySelector(".img_mask")||"";let r=this.$bar.getX()+this.$bar.getWidth(),h=i.getX()+t,d=a&&a.getX()+t||0,g=a&&a.getBBox().width+7||7,l=h+i.getBBox().width+7,_=e+s.clientWidth/2;i.classList.contains("big")||(l<r&&t>0&&l<_||h-g>this.$bar.getX()&&t<0&&l>_)&&(i.setAttribute("x",h),a&&(a.setAttribute("x",d),o.setAttribute("x",d)))}date_changed(){let t=!1;const{new_start_date:e,new_end_date:s}=this.compute_start_end_date();Number(this.task._start)!==Number(e)&&(t=!0,this.task._start=e),Number(this.task._end)!==Number(s)&&(t=!0,this.task._end=s),t&&this.gantt.trigger_event("date_change",[this.task,e,c.add(s,-1,"second")])}progress_changed(){this.task.progress=this.compute_progress(),this.gantt.trigger_event("progress_change",[this.task,this.task.progress])}set_action_completed(){this.action_completed=!0,setTimeout(()=>this.action_completed=!1,1e3)}compute_start_end_date(){const t=this.$bar,e=t.getX()/this.gantt.config.column_width;let s=c.add(this.gantt.gantt_start,e*this.gantt.config.step,this.gantt.config.unit);const i=t.getWidth()/this.gantt.config.column_width,a=c.add(s,i*this.gantt.config.step,this.gantt.config.unit);return{new_start_date:s,new_end_date:a}}compute_progress(){this.progress_width=this.$bar_progress.getWidth(),this.x=this.$bar_progress.getBBox().x;const t=this.x+this.progress_width,e=this.progress_width-this.gantt.config.ignored_positions.reduce((i,a)=>i+(a>=this.x&&a<=t),0)*this.gantt.config.column_width;if(e<0)return 0;const s=this.$bar.getWidth()-this.ignored_duration_raw*this.gantt.config.column_width;return parseInt(e/s*100,10)}compute_expected_progress(){this.expected_progress=c.diff(c.today(),this.task._start,"hour")/this.gantt.config.step,this.expected_progress=(this.expected_progress<this.duration?this.expected_progress:this.duration)*100/this.duration}compute_x(){const{column_width:t}=this.gantt.config,e=this.task._start,s=this.gantt.gantt_start;let i=c.diff(e,s,this.gantt.config.unit)/this.gantt.config.step*t;this.x=i}compute_y(){this.y=this.gantt.config.header_height+this.gantt.options.padding/2+this.task._index*(this.height+this.gantt.options.padding)}compute_duration(){let t=0,e=0;for(let s=new Date(this.task._start);s<this.task._end;s.setDate(s.getDate()+1))e++,!this.gantt.config.ignored_dates.find(i=>i.getTime()===s.getTime())&&(!this.gantt.config.ignored_function||!this.gantt.config.ignored_function(s))&&t++;this.task.actual_duration=t,this.task.ignored_duration=e-t,this.duration=c.convert_scales(e+"d",this.gantt.config.unit)/this.gantt.config.step,this.actual_duration_raw=c.convert_scales(t+"d",this.gantt.config.unit)/this.gantt.config.step,this.ignored_duration_raw=this.duration-this.actual_duration_raw}update_attr(t,e,s){return s=+s,isNaN(s)||t.setAttribute(e,s),t}update_expected_progressbar_position(){this.invalid||(this.$expected_bar_progress.setAttribute("x",this.$bar.getX()),this.compute_expected_progress(),this.$expected_bar_progress.setAttribute("width",this.gantt.config.column_width*this.actual_duration_raw*(this.expected_progress/100)||0))}update_progressbar_position(){this.invalid||this.gantt.options.readonly||(this.$bar_progress.setAttribute("x",this.$bar.getX()),this.$bar_progress.setAttribute("width",this.calculate_progress_width()))}update_label_position(){const t=this.bar_group.querySelector(".img_mask")||"",e=this.$bar,s=this.group.querySelector(".bar-label"),i=this.group.querySelector(".bar-img");let a=5,o=this.image_size+10;const r=s.getBBox().width,h=e.getWidth();r>h?(s.classList.add("big"),i?(i.setAttribute("x",e.getEndX()+a),t.setAttribute("x",e.getEndX()+a),s.setAttribute("x",e.getEndX()+o)):s.setAttribute("x",e.getEndX()+a)):(s.classList.remove("big"),i?(i.setAttribute("x",e.getX()+a),t.setAttribute("x",e.getX()+a),s.setAttribute("x",e.getX()+h/2+o)):s.setAttribute("x",e.getX()+h/2-r/2))}update_handle_position(){if(this.invalid||this.gantt.options.readonly)return;const t=this.$bar;this.handle_group.querySelector(".handle.left").setAttribute("x",t.getX()),this.handle_group.querySelector(".handle.right").setAttribute("x",t.getEndX());const e=this.group.querySelector(".handle.progress");e&&e.setAttribute("cx",this.$bar_progress.getEndX())}update_arrow_position(){this.arrows=this.arrows||[];for(let t of this.arrows)t.update()}}class kt{constructor(t,e,s){this.parent=t,this.popup_func=e,this.gantt=s,this.make()}make(){this.parent.innerHTML=`
            <div class="title"></div>
            <div class="subtitle"></div>
            <div class="details"></div>
            <div class="actions"></div>
        `,this.hide(),this.title=this.parent.querySelector(".title"),this.subtitle=this.parent.querySelector(".subtitle"),this.details=this.parent.querySelector(".details"),this.actions=this.parent.querySelector(".actions")}show({x:t,y:e,task:s,target:i}){this.actions.innerHTML="";let a=this.popup_func({task:s,chart:this.gantt,get_title:()=>this.title,set_title:o=>this.title.innerHTML=o,get_subtitle:()=>this.subtitle,set_subtitle:o=>this.subtitle.innerHTML=o,get_details:()=>this.details,set_details:o=>this.details.innerHTML=o,add_action:(o,r)=>{let h=this.gantt.create_el({classes:"action-btn",type:"button",append_to:this.actions});typeof o=="function"&&(o=o(s)),h.innerHTML=o,h.onclick=d=>r(s,this.gantt,d)}});a!==!1&&(a&&(this.parent.innerHTML=a),this.actions.innerHTML===""?this.actions.remove():this.parent.appendChild(this.actions),this.parent.style.left=t+10+"px",this.parent.style.top=e-10+"px",this.parent.classList.remove("hide"))}hide(){this.parent.classList.add("hide")}}function st(n){const t=n.getFullYear();return t-t%10+""}function Mt(n,t,e){let s=c.add(n,6,"day"),i=s.getMonth()!==n.getMonth()?"D MMM":"D",a=!t||n.getMonth()!==t.getMonth()?"D MMM":"D";return`${c.format(n,a,e)} - ${c.format(s,i,e)}`}const E=[{name:"Hour",padding:"7d",step:"1h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?c.format(n,"D MMMM",e):"",upper_text_frequency:24},{name:"Quarter Day",padding:"7d",step:"6h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?c.format(n,"D MMM",e):"",upper_text_frequency:4},{name:"Half Day",padding:"14d",step:"12h",date_format:"YYYY-MM-DD HH:",lower_text:"HH",upper_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?n.getMonth()!==n.getMonth()?c.format(n,"D MMM",e):c.format(n,"D",e):"",upper_text_frequency:2},{name:"Day",padding:"7d",date_format:"YYYY-MM-DD",step:"1d",lower_text:(n,t,e)=>!t||n.getDate()!==t.getDate()?c.format(n,"D",e):"",upper_text:(n,t,e)=>!t||n.getMonth()!==t.getMonth()?c.format(n,"MMMM",e):"",thick_line:n=>n.getDay()===1},{name:"Week",padding:"1m",step:"7d",date_format:"YYYY-MM-DD",column_width:140,lower_text:Mt,upper_text:(n,t,e)=>!t||n.getMonth()!==t.getMonth()?c.format(n,"MMMM",e):"",thick_line:n=>n.getDate()>=1&&n.getDate()<=7,upper_text_frequency:4},{name:"Month",padding:"2m",step:"1m",column_width:120,date_format:"YYYY-MM",lower_text:"MMMM",upper_text:(n,t,e)=>!t||n.getFullYear()!==t.getFullYear()?c.format(n,"YYYY",e):"",thick_line:n=>n.getMonth()%3===0,snap_at:"7d"},{name:"Year",padding:"2y",step:"1y",column_width:120,date_format:"YYYY",upper_text:(n,t,e)=>!t||st(n)!==st(t)?st(n):"",lower_text:"YYYY",snap_at:"30d"}],Dt={arrow_curve:5,auto_move_label:!1,bar_corner_radius:3,bar_height:30,container_height:"auto",column_width:null,date_format:"YYYY-MM-DD HH:mm",upper_header_height:45,lower_header_height:30,snap_at:null,infinite_padding:!0,holidays:{"var(--g-weekend-highlight-color)":"weekend"},ignore:[],language:"en",lines:"both",move_dependencies:!0,padding:18,popup:n=>{n.set_title(n.task.name),n.task.description?n.set_subtitle(n.task.description):n.set_subtitle("");const t=c.format(n.task._start,"MMM D",n.chart.options.language),e=c.format(c.add(n.task._end,-1,"second"),"MMM D",n.chart.options.language);n.set_details(`${t} - ${e} (${n.task.actual_duration} days${n.task.ignored_duration?" + "+n.task.ignored_duration+" excluded":""})<br/>Progress: ${Math.floor(n.task.progress*100)/100}%`)},popup_on:"click",readonly_progress:!1,readonly_dates:!1,readonly:!1,scroll_to:"today",show_expected_progress:!1,today_button:!0,view_mode:"Day",view_mode_select:!1,view_modes:E,is_weekend:n=>n.getDay()===0||n.getDay()===6};class gt{constructor(t,e,s){this.setup_wrapper(t),this.setup_options(s),this.setup_tasks(e),this.change_view_mode(),this.bind_events()}setup_wrapper(t){let e,s;if(typeof t=="string"){let i=document.querySelector(t);if(!i)throw new ReferenceError(`CSS selector "${t}" could not be found in DOM`);t=i}if(t instanceof HTMLElement)s=t,e=t.querySelector("svg");else if(t instanceof SVGElement)e=t;else throw new TypeError("Frappe Gantt only supports usage of a string CSS selector, HTML DOM element or SVG DOM element for the 'element' parameter");e?(this.$svg=e,this.$svg.classList.add("gantt")):this.$svg=x("svg",{append_to:s,class:"gantt"}),this.$container=this.create_el({classes:"gantt-container",append_to:this.$svg.parentElement}),this.$container.appendChild(this.$svg),this.$popup_wrapper=this.create_el({classes:"popup-wrapper",append_to:this.$container})}setup_options(t){this.original_options=t,t!=null&&t.view_modes&&(t.view_modes=t.view_modes.map(s=>{if(typeof s=="string"){const i=E.find(a=>a.name===s);return i||console.error(`The view mode "${s}" is not predefined in Frappe Gantt. Please define the view mode object instead.`),i}return s}),t.view_mode=t.view_modes[0]),this.options={...Dt,...t};const e={"grid-height":"container_height","bar-height":"bar_height","lower-header-height":"lower_header_height","upper-header-height":"upper_header_height"};for(let s in e){let i=this.options[e[s]];i!=="auto"&&this.$container.style.setProperty("--gv-"+s,i+"px")}if(this.config={ignored_dates:[],ignored_positions:[],extend_by_units:10},typeof this.options.ignore!="function"){typeof this.options.ignore=="string"&&(this.options.ignore=[this.options.ignore]);for(let s of this.options.ignore){if(typeof s=="function"){this.config.ignored_function=s;continue}typeof s=="string"&&(s==="weekend"?this.config.ignored_function=i=>i.getDay()==6||i.getDay()==0:this.config.ignored_dates.push(new Date(s+" ")))}}else this.config.ignored_function=this.options.ignore}update_options(t){this.setup_options({...this.original_options,...t}),this.change_view_mode(void 0,!0)}setup_tasks(t){this.tasks=t.map((e,s)=>{if(!e.start)return console.error(`task "${e.id}" doesn't have a start date`),!1;if(e._start=c.parse(e.start),e.end===void 0&&e.duration!==void 0&&(e.end=e._start,e.duration.split(" ").forEach(i=>{let{duration:a,scale:o}=c.parse_duration(i);e.end=c.add(e.end,a,o)})),!e.end)return console.error(`task "${e.id}" doesn't have an end date`),!1;if(e._end=c.parse(e.end),c.diff(e._end,e._start,"year")<0)return console.error(`start of task can't be after end of task: in task "${e.id}"`),!1;if(c.diff(e._end,e._start,"year")>10)return console.error(`the duration of task "${e.id}" is too long (above ten years)`),!1;if(e._index=s,c.get_date_values(e._end).slice(3).every(i=>i===0)&&(e._end=c.add(e._end,24,"hour")),typeof e.dependencies=="string"||!e.dependencies){let i=[];e.dependencies&&(i=e.dependencies.split(",").map(a=>a.trim().replaceAll(" ","_")).filter(a=>a)),e.dependencies=i}return e.id?typeof e.id=="string"?e.id=e.id.replaceAll(" ","_"):e.id=`${e.id}`:e.id=Lt(e),e}).filter(e=>e),this.setup_dependencies()}setup_dependencies(){this.dependency_map={};for(let t of this.tasks)for(let e of t.dependencies)this.dependency_map[e]=this.dependency_map[e]||[],this.dependency_map[e].push(t.id)}refresh(t){this.setup_tasks(t),this.change_view_mode()}update_task(t,e){let s=this.tasks.find(a=>a.id===t),i=this.bars[s._index];Object.assign(s,e),i.refresh()}change_view_mode(t=this.options.view_mode,e=!1){typeof t=="string"&&(t=this.options.view_modes.find(a=>a.name===t));let s,i;e&&(s=this.$container.scrollLeft,i=this.options.scroll_to,this.options.scroll_to=null),this.options.view_mode=t.name,this.config.view_mode=t,this.update_view_scale(t),this.setup_dates(e),this.render(),e&&(this.$container.scrollLeft=s,this.options.scroll_to=i),this.trigger_event("view_change",[t])}update_view_scale(t){let{duration:e,scale:s}=c.parse_duration(t.step);this.config.step=e,this.config.unit=s,this.config.column_width=this.options.column_width||t.column_width||45,this.$container.style.setProperty("--gv-column-width",this.config.column_width+"px"),this.config.header_height=this.options.lower_header_height+this.options.upper_header_height+10}setup_dates(t=!1){this.setup_gantt_dates(t),this.setup_date_values()}setup_gantt_dates(t){let e,s;this.tasks.length||(e=new Date,s=new Date);for(let i of this.tasks)(!e||i._start<e)&&(e=i._start),(!s||i._end>s)&&(s=i._end);if(e=c.start_of(e,this.config.unit),s=c.start_of(s,this.config.unit),!t)if(this.options.infinite_padding)this.gantt_start=c.add(e,-this.config.extend_by_units*3,this.config.unit),this.gantt_end=c.add(s,this.config.extend_by_units*3,this.config.unit);else{typeof this.config.view_mode.padding=="string"&&(this.config.view_mode.padding=[this.config.view_mode.padding,this.config.view_mode.padding]);let[i,a]=this.config.view_mode.padding.map(c.parse_duration);this.gantt_start=c.add(e,-i.duration,i.scale),this.gantt_end=c.add(s,a.duration,a.scale)}this.config.date_format=this.config.view_mode.date_format||this.options.date_format,this.gantt_start.setHours(0,0,0,0)}setup_date_values(){let t=this.gantt_start;for(this.dates=[t];t<this.gantt_end;)t=c.add(t,this.config.step,this.config.unit),this.dates.push(t)}bind_events(){this.bind_grid_click(),this.bind_holiday_labels(),this.bind_bar_events()}render(){this.clear(),this.setup_layers(),this.make_grid(),this.make_dates(),this.make_grid_extras(),this.make_bars(),this.make_arrows(),this.map_arrows_on_bars(),this.set_dimensions(),this.set_scroll_position(this.options.scroll_to)}setup_layers(){this.layers={};const t=["grid","arrow","progress","bar"];for(let e of t)this.layers[e]=x("g",{class:e,append_to:this.$svg});this.$extras=this.create_el({classes:"extras",append_to:this.$container}),this.$adjust=this.create_el({classes:"adjust hide",append_to:this.$extras,type:"button"}),this.$adjust.innerHTML="&larr;"}make_grid(){this.make_grid_background(),this.make_grid_rows(),this.make_grid_header(),this.make_side_header()}make_grid_extras(){this.make_grid_highlights(),this.make_grid_ticks()}make_grid_background(){const t=this.dates.length*this.config.column_width,e=Math.max(this.config.header_height+this.options.padding+(this.options.bar_height+this.options.padding)*this.tasks.length-10,this.options.container_height!=="auto"?this.options.container_height:0);x("rect",{x:0,y:0,width:t,height:e,class:"grid-background",append_to:this.$svg}),f.attr(this.$svg,{height:e,width:"100%"}),this.grid_height=e,this.options.container_height==="auto"&&(this.$container.style.height=e+"px")}make_grid_rows(){const t=x("g",{append_to:this.layers.grid}),e=this.dates.length*this.config.column_width,s=this.options.bar_height+this.options.padding;this.config.header_height;for(let i=this.config.header_height;i<this.grid_height;i+=s)x("rect",{x:0,y:i,width:e,height:s,class:"grid-row",append_to:t})}make_grid_header(){this.$header=this.create_el({width:this.dates.length*this.config.column_width,classes:"grid-header",append_to:this.$container}),this.$upper_header=this.create_el({classes:"upper-header",append_to:this.$header}),this.$lower_header=this.create_el({classes:"lower-header",append_to:this.$header})}make_side_header(){if(this.$side_header=this.create_el({classes:"side-header"}),this.$upper_header.prepend(this.$side_header),this.options.view_mode_select){const t=document.createElement("select");t.classList.add("viewmode-select");const e=document.createElement("option");e.selected=!0,e.disabled=!0,e.textContent="Mode",t.appendChild(e);for(const s of this.options.view_modes){const i=document.createElement("option");i.value=s.name,i.textContent=s.name,s.name===this.config.view_mode.name&&(i.selected=!0),t.appendChild(i)}t.addEventListener("change",(function(){this.change_view_mode(t.value,!0)}).bind(this)),this.$side_header.appendChild(t)}if(this.options.today_button){let t=document.createElement("button");t.classList.add("today-button"),t.textContent="Today",t.onclick=this.scroll_current.bind(this),this.$side_header.prepend(t),this.$today_button=t}}make_grid_ticks(){if(this.options.lines==="none")return;let t=0,e=this.config.header_height,s=this.grid_height-this.config.header_height,i=x("g",{class:"lines_layer",append_to:this.layers.grid}),a=this.config.header_height;const o=this.dates.length*this.config.column_width,r=this.options.bar_height+this.options.padding;if(this.options.lines!=="vertical")for(let h=this.config.header_height;h<this.grid_height;h+=r)x("line",{x1:0,y1:a+r,x2:o,y2:a+r,class:"row-line",append_to:i}),a+=r;if(this.options.lines!=="horizontal")for(let h of this.dates){let d="tick";this.config.view_mode.thick_line&&this.config.view_mode.thick_line(h)&&(d+=" thick"),x("path",{d:`M ${t} ${e} v ${s}`,class:d,append_to:this.layers.grid}),this.view_is("month")?t+=c.get_days_in_month(h)*this.config.column_width/30:this.view_is("year")?t+=c.get_days_in_year(h)*this.config.column_width/365:t+=this.config.column_width}}highlight_holidays(){let t={};if(this.options.holidays)for(let e in this.options.holidays){let s=this.options.holidays[e];s==="weekend"&&(s=this.options.is_weekend);let i;if(typeof s=="object"){let a=s.find(o=>typeof o=="function");if(a&&(i=a),this.options.holidays.name){let o=new Date(s.date+" ");s=r=>o.getTime()===r.getTime(),t[o]=s.name}else s=o=>this.options.holidays[e].filter(r=>typeof r!="function").map(r=>{if(r.name){let h=new Date(r.date+" ");return t[h]=r.name,h.getTime()}return new Date(r+" ").getTime()}).includes(o.getTime())}for(let a=new Date(this.gantt_start);a<=this.gantt_end;a.setDate(a.getDate()+1))if(!(this.config.ignored_dates.find(o=>o.getTime()==a.getTime())||this.config.ignored_function&&this.config.ignored_function(a))&&(s(a)||i&&i(a))){const o=c.diff(a,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width,r=this.grid_height-this.config.header_height,h=c.format(a,"YYYY-MM-DD",this.options.language).replace(" ","_");if(t[a]){let d=this.create_el({classes:"holiday-label label_"+h,append_to:this.$extras});d.textContent=t[a]}x("rect",{x:Math.round(o),y:this.config.header_height,width:this.config.column_width/c.convert_scales(this.config.view_mode.step,"day"),height:r,class:"holiday-highlight "+h,style:`fill: ${e};`,append_to:this.layers.grid})}}}highlight_current(){const t=this.get_closest_date();if(!t)return;const[e,s]=t;s.classList.add("current-date-highlight");const i=c.diff(new Date,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.$current_highlight=this.create_el({top:this.config.header_height,left:i,height:this.grid_height-this.config.header_height,classes:"current-highlight",append_to:this.$container}),this.$current_ball_highlight=this.create_el({top:this.config.header_height-6,left:i-2.5,width:6,height:6,classes:"current-ball-highlight",append_to:this.$header})}make_grid_highlights(){this.highlight_holidays(),this.config.ignored_positions=[];const t=(this.options.bar_height+this.options.padding)*this.tasks.length;this.layers.grid.innerHTML+=`<pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
          <path d="M-1,1 l2,-2
                   M0,4 l4,-4
                   M3,5 l2,-2"
                style="stroke:grey; stroke-width:0.3" />
        </pattern>`;for(let e=new Date(this.gantt_start);e<=this.gantt_end;e.setDate(e.getDate()+1)){if(!this.config.ignored_dates.find(i=>i.getTime()==e.getTime())&&(!this.config.ignored_function||!this.config.ignored_function(e)))continue;let s=c.convert_scales(c.diff(e,this.gantt_start)+"d",this.config.unit)/this.config.step;this.config.ignored_positions.push(s*this.config.column_width),x("rect",{x:s*this.config.column_width,y:this.config.header_height,width:this.config.column_width,height:t,class:"ignored-bar",style:"fill: url(#diagonalHatch);",append_to:this.$svg})}this.highlight_current(this.config.view_mode)}create_el({left:t,top:e,width:s,height:i,id:a,classes:o,append_to:r,type:h}){let d=document.createElement(h||"div");for(let g of o.split(" "))d.classList.add(g);return d.style.top=e+"px",d.style.left=t+"px",a&&(d.id=a),s&&(d.style.width=s+"px"),i&&(d.style.height=i+"px"),r&&r.appendChild(d),d}make_dates(){this.get_dates_to_draw().forEach((t,e)=>{if(t.lower_text){let s=this.create_el({left:t.x,top:t.lower_y,classes:"lower-text date_"+O(t.formatted_date),append_to:this.$lower_header});s.innerText=t.lower_text}if(t.upper_text){let s=this.create_el({left:t.x,top:t.upper_y,classes:"upper-text",append_to:this.$upper_header});s.innerText=t.upper_text}}),this.upperTexts=Array.from(this.$container.querySelectorAll(".upper-text"))}get_dates_to_draw(){let t=null;return this.dates.map((e,s)=>{const i=this.get_date_info(e,t,s);return t=i,i})}get_date_info(t,e){let s=e?e.date:null;this.config.column_width;const i=e?e.x+e.column_width:0;let a=this.config.view_mode.upper_text,o=this.config.view_mode.lower_text;return a?typeof a=="string"&&(this.config.view_mode.upper_text=r=>c.format(r,a,this.options.language)):this.config.view_mode.upper_text=()=>"",o?typeof o=="string"&&(this.config.view_mode.lower_text=r=>c.format(r,o,this.options.language)):this.config.view_mode.lower_text=()=>"",{date:t,formatted_date:O(c.format(t,this.config.date_format,this.options.language)),column_width:this.config.column_width,x:i,upper_text:this.config.view_mode.upper_text(t,s,this.options.language),lower_text:this.config.view_mode.lower_text(t,s,this.options.language),upper_y:17,lower_y:this.options.upper_header_height+5}}make_bars(){this.bars=this.tasks.map(t=>{const e=new $t(this,t);return this.layers.bar.appendChild(e.group),e})}make_arrows(){this.arrows=[];for(let t of this.tasks){let e=[];e=t.dependencies.map(s=>{const i=this.get_task(s);if(!i)return;const a=new vt(this,this.bars[i._index],this.bars[t._index]);return this.layers.arrow.appendChild(a.element),a}).filter(Boolean),this.arrows=this.arrows.concat(e)}}map_arrows_on_bars(){for(let t of this.bars)t.arrows=this.arrows.filter(e=>e.from_task.task.id===t.task.id||e.to_task.task.id===t.task.id)}set_dimensions(){const{width:t}=this.$svg.getBoundingClientRect(),e=this.$svg.querySelector(".grid .grid-row")?this.$svg.querySelector(".grid .grid-row").getAttribute("width"):0;t<e&&this.$svg.setAttribute("width",e)}set_scroll_position(t){if(this.options.infinite_padding&&(!t||t==="start")){let[a,...o]=this.get_start_end_positions();this.$container.scrollLeft=a;return}if(!t||t==="start")t=this.gantt_start;else if(t==="end")t=this.gantt_end;else{if(t==="today")return this.scroll_current();typeof t=="string"&&(t=c.parse(t))}const e=c.diff(t,this.gantt_start,this.config.unit)/this.config.step*this.config.column_width;this.$container.scrollTo({left:e-this.config.column_width/6,behavior:"smooth"}),this.$current&&this.$current.classList.remove("current-upper"),this.current_date=c.add(this.gantt_start,this.$container.scrollLeft/this.config.column_width,this.config.unit);let s=this.config.view_mode.upper_text(this.current_date,null,this.options.language),i=this.upperTexts.find(a=>a.textContent===s);this.current_date=c.add(this.gantt_start,(this.$container.scrollLeft+i.clientWidth)/this.config.column_width,this.config.unit),s=this.config.view_mode.upper_text(this.current_date,null,this.options.language),i=this.upperTexts.find(a=>a.textContent===s),i.classList.add("current-upper"),this.$current=i}scroll_current(){let t=this.get_closest_date();t&&this.set_scroll_position(t[0])}get_closest_date(){let t=new Date;if(t<this.gantt_start||t>this.gantt_end)return null;let e=new Date,s=this.$container.querySelector(".date_"+O(c.format(e,this.config.date_format,this.options.language))),i=0;for(;!s&&i<this.config.step;)e=c.add(e,-1,this.config.unit),s=this.$container.querySelector(".date_"+O(c.format(e,this.config.date_format,this.options.language))),i++;return[new Date(c.format(e,this.config.date_format,this.options.language)+" "),s]}bind_grid_click(){f.on(this.$container,"click",".grid-row, .grid-header, .ignored-bar, .holiday-highlight",()=>{this.unselect_all(),this.hide_popup()})}bind_holiday_labels(){const t=this.$container.querySelectorAll(".holiday-highlight");for(let e of t){const s=this.$container.querySelector(".label_"+e.classList[1]);if(!s)continue;let i;e.onmouseenter=a=>{i=setTimeout(()=>{s.classList.add("show"),s.style.left=(a.offsetX||a.layerX)+"px",s.style.top=(a.offsetY||a.layerY)+"px"},300)},e.onmouseleave=a=>{clearTimeout(i),s.classList.remove("show")}}}get_start_end_positions(){if(!this.bars.length)return[0,0,0];let{x:t,width:e}=this.bars[0].group.getBBox(),s=t,i=t,a=t+e;return Array.prototype.forEach.call(this.bars,function({group:o},r){let{x:h,width:d}=o.getBBox();h<s&&(s=h),h>i&&(i=h),h+d>a&&(a=h+d)}),[s,i,a]}bind_bar_events(){let t=!1,e=0,s=0,i=!1,a=!1,o=null,r=[];this.bar_being_dragged=null;const h=()=>t||i||a;this.$svg.onclick=g=>{g.target.classList.contains("grid-row")&&this.unselect_all()};let d=0;if(f.on(this.$svg,"mousemove",".bar-wrapper, .handle",g=>{this.bar_being_dragged===!1&&Math.abs((g.offsetX||g.layerX)-d)>10&&(this.bar_being_dragged=!0)}),f.on(this.$svg,"mousedown",".bar-wrapper, .handle",(g,l)=>{const _=f.closest(".bar-wrapper",l);l.classList.contains("left")?(i=!0,l.classList.add("visible")):l.classList.contains("right")?(a=!0,l.classList.add("visible")):l.classList.contains("bar-wrapper")&&(t=!0),this.popup&&this.popup.hide(),e=g.offsetX||g.layerX,o=_.getAttribute("data-id");let w;this.options.move_dependencies?w=[o,...this.get_all_dependent_tasks(o)]:w=[o],r=w.map(T=>this.get_bar(T)),this.bar_being_dragged=!1,d=e,r.forEach(T=>{const v=T.$bar;v.ox=v.getX(),v.oy=v.getY(),v.owidth=v.getWidth(),v.finaldx=0})}),this.options.infinite_padding){let g=!1;f.on(this.$container,"mousewheel",l=>{let _=this.$container.scrollWidth/2;if(!g&&l.currentTarget.scrollLeft<=_){let w=l.currentTarget.scrollLeft;g=!0,this.gantt_start=c.add(this.gantt_start,-this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),l.currentTarget.scrollLeft=w+this.config.column_width*this.config.extend_by_units,setTimeout(()=>g=!1,300)}if(!g&&l.currentTarget.scrollWidth-(l.currentTarget.scrollLeft+l.currentTarget.clientWidth)<=_){let w=l.currentTarget.scrollLeft;g=!0,this.gantt_end=c.add(this.gantt_end,this.config.extend_by_units,this.config.unit),this.setup_date_values(),this.render(),l.currentTarget.scrollLeft=w,setTimeout(()=>g=!1,300)}})}f.on(this.$container,"scroll",g=>{let l=[];const _=this.bars.map(({group:$})=>$.getAttribute("data-id"));let w;s&&(w=g.currentTarget.scrollLeft-s),this.current_date=c.add(this.gantt_start,g.currentTarget.scrollLeft/this.config.column_width*this.config.step,this.config.unit);let T=this.config.view_mode.upper_text(this.current_date,null,this.options.language),v=this.upperTexts.find($=>$.textContent===T);this.current_date=c.add(this.gantt_start,(g.currentTarget.scrollLeft+v.clientWidth)/this.config.column_width*this.config.step,this.config.unit),T=this.config.view_mode.upper_text(this.current_date,null,this.options.language),v=this.upperTexts.find($=>$.textContent===T),v!==this.$current&&(this.$current&&this.$current.classList.remove("current-upper"),v.classList.add("current-upper"),this.$current=v),s=g.currentTarget.scrollLeft;let[F,I,V]=this.get_start_end_positions();s>V+100?(this.$adjust.innerHTML="&larr;",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:I,behavior:"smooth"})}):s+g.currentTarget.offsetWidth<F-100?(this.$adjust.innerHTML="&rarr;",this.$adjust.classList.remove("hide"),this.$adjust.onclick=()=>{this.$container.scrollTo({left:F,behavior:"smooth"})}):this.$adjust.classList.add("hide"),w&&(l=_.map($=>this.get_bar($)),this.options.auto_move_label&&l.forEach($=>{$.update_label_position_on_horizontal_scroll({x:w,sx:g.currentTarget.scrollLeft})}))}),f.on(this.$svg,"mousemove",g=>{if(!h())return;const l=(g.offsetX||g.layerX)-e;r.forEach(_=>{const w=_.$bar;w.finaldx=this.get_snap_position(l,w.ox),this.hide_popup(),i?o===_.task.id?_.update_bar_position({x:w.ox+w.finaldx,width:w.owidth-w.finaldx}):_.update_bar_position({x:w.ox+w.finaldx}):a?o===_.task.id&&_.update_bar_position({width:w.owidth+w.finaldx}):t&&!this.options.readonly&&!this.options.readonly_dates&&_.update_bar_position({x:w.ox+w.finaldx})})}),document.addEventListener("mouseup",()=>{var g,l,_;t=!1,i=!1,a=!1,(_=(l=(g=this.$container.querySelector(".visible"))==null?void 0:g.classList)==null?void 0:l.remove)==null||_.call(l,"visible")}),f.on(this.$svg,"mouseup",g=>{this.bar_being_dragged=null,r.forEach(l=>{l.$bar.finaldx&&(l.date_changed(),l.compute_progress(),l.set_action_completed())})}),this.bind_bar_progress()}bind_bar_progress(){let t=0,e=null,s=null,i=null,a=null;f.on(this.$svg,"mousedown",".handle.progress",(r,h)=>{e=!0,t=r.offsetX||r.layerX;const d=f.closest(".bar-wrapper",h).getAttribute("data-id");s=this.get_bar(d),i=s.$bar_progress,a=s.$bar,i.finaldx=0,i.owidth=i.getWidth(),i.min_dx=-i.owidth,i.max_dx=a.getWidth()-i.getWidth()});const o=this.config.ignored_positions.map(r=>[r,r+this.config.column_width]);f.on(this.$svg,"mousemove",r=>{if(!e)return;let h=r.offsetX||r.layerX;if(h>t){let g=o.find(([l,_])=>h>=l&&h<_);for(;g;)h=g[1],g=o.find(([l,_])=>h>=l&&h<_)}else{let g=o.find(([l,_])=>h>l&&h<=_);for(;g;)h=g[0],g=o.find(([l,_])=>h>l&&h<=_)}let d=h-t;console.log(i),d>i.max_dx&&(d=i.max_dx),d<i.min_dx&&(d=i.min_dx),i.setAttribute("width",i.owidth+d),f.attr(s.$handle_progress,"cx",i.getEndX()),i.finaldx=d}),f.on(this.$svg,"mouseup",()=>{e=!1,i&&i.finaldx&&(i.finaldx=0,s.progress_changed(),s.set_action_completed(),s=null,i=null,a=null)})}get_all_dependent_tasks(t){let e=[],s=[t];for(;s.length;){const i=s.reduce((a,o)=>(a=a.concat(this.dependency_map[o]),a),[]);e=e.concat(i),s=i.filter(a=>!s.includes(a))}return e.filter(Boolean)}get_snap_position(t,e){let s=1;const i=this.options.snap_at||this.config.view_mode.snap_at||"1d";if(i!=="unit"){const{duration:g,scale:l}=c.parse_duration(i);s=c.convert_scales(this.config.view_mode.step,l)/g}const a=t%(this.config.column_width/s);let o=t-a+(a<this.config.column_width/s*2?0:this.config.column_width/s),r=e+o;const h=o>0?1:-1;let d=this.get_ignored_region(r,h);for(;d.length;)r+=this.config.column_width*h,d=this.get_ignored_region(r,h),d.length||(r-=this.config.column_width*h);return r-e}get_ignored_region(t,e=1){return e===1?this.config.ignored_positions.filter(s=>t>s&&t<=s+this.config.column_width):this.config.ignored_positions.filter(s=>t>=s&&t<s+this.config.column_width)}unselect_all(){this.popup&&this.popup.parent.classList.add("hide"),this.$container.querySelectorAll(".date-range-highlight").forEach(t=>t.classList.add("hide"))}view_is(t){return typeof t=="string"?this.config.view_mode.name===t:Array.isArray(t)?t.some(view_is):this.config.view_mode.name===t.name}get_task(t){return this.tasks.find(e=>e.id===t)}get_bar(t){return this.bars.find(e=>e.task.id===t)}show_popup(t){this.options.popup!==!1&&(this.popup||(this.popup=new kt(this.$popup_wrapper,this.options.popup,this)),this.popup.show(t))}hide_popup(){this.popup&&this.popup.hide()}trigger_event(t,e){this.options["on_"+t]&&this.options["on_"+t].apply(this,e)}get_oldest_starting_date(){return this.tasks.length?this.tasks.map(t=>t._start).reduce((t,e)=>e<=t?e:t):new Date}clear(){var t,e,s,i,a,o,r,h,d,g;this.$svg.innerHTML="",(e=(t=this.$header)==null?void 0:t.remove)==null||e.call(t),(i=(s=this.$side_header)==null?void 0:s.remove)==null||i.call(s),(o=(a=this.$current_highlight)==null?void 0:a.remove)==null||o.call(a),(h=(r=this.$extras)==null?void 0:r.remove)==null||h.call(r),(g=(d=this.popup)==null?void 0:d.hide)==null||g.call(d)}}gt.VIEW_MODE={HOUR:E[0],QUARTER_DAY:E[1],HALF_DAY:E[2],DAY:E[3],WEEK:E[4],MONTH:E[5],YEAR:E[6]};function Lt(n){return n.name+"_"+Math.random().toString(36).slice(2,12)}function O(n){return n.replaceAll(" ","_").replaceAll(":","_").replaceAll(".","_")}function Yt({nodes:n=[],edges:t=[],onEntitySelect:e,locale:s="en"}){const i=L.useRef(null),a=L.useRef(null),[o,r]=L.useState("Week"),h=["planned","in-progress","done","blocked"],d=L.useMemo(()=>Array.from(new Set(n.map(u=>u?.data?.branch).filter(Boolean))).sort(ct),[n]),g=L.useMemo(()=>Array.from(new Set(n.flatMap(u=>u?.data?.tags??[]))).sort(),[n]),[l,_]=L.useState(()=>new Set(d)),[w,T]=L.useState(()=>new Set(h)),[v,F]=L.useState(()=>new Set),[I,V]=L.useState(()=>new Set);L.useEffect(()=>{l.size===0&&d.length>0&&_(new Set(d))},[d]);const{tasks:$,minDate:W,maxDate:R,hiddenCount:nt}=L.useMemo(()=>{const u=n.filter(p=>p?.data?.date),S=p=>{if(!v.size)return!0;const m=new Set(p||[]);for(const y of v)if(m.has(y))return!0;return!1},k=u.filter(p=>l.has(p?.data?.branch||"")).filter(p=>w.has(p?.data?.status||"planned")).filter(p=>S(p?.data?.tags)),z=new Set(["parent","blocks","implements","integrates"]),Y=new Map;for(const p of t||[]){const m=p?.data?.linkType||p?.data?.type||p?.type;z.has(m)&&(Y.has(p.target)||Y.set(p.target,[]),Y.get(p.target).push(p.source))}const X=new Map,M=[...k].sort((p,m)=>new Date(p.data.date)-new Date(m.data.date));for(const p of M){const m=p.data?.branch||"main",y=X.get(m)||[];y.push(p),X.set(m,y)}const j=new Map;for(const[p,m]of X)for(let y=0;y<m.length-1;y++)j.set(m[y].id,m[y+1]);const A=[],C=new Set,B=p=>{const m=new Date(p.data.date),y=dt(p,j,m),D=p.data?.status||"planned",H=(p.data?.tags||[]).includes("milestone"),N=p.data?.branch||"main",q=`status-${D}--branch-${N}${H?"--milestone":""}`;return{id:p.id,name:p.data?.label||p.id,start:m,end:y,progress:D==="done"?100:D==="in-progress"?50:0,dependencies:(Y.get(p.id)||[]).slice(),custom_class:q}},P=[...X.keys()].sort(ct);for(const p of P){const m=X.get(p)||[];if(!m.length)continue;m.sort((N,q)=>new Date(N.data.date)-new Date(q.data.date));const y=new Date(m[0].data.date),D=dt(m[m.length-1],j,new Date(m[m.length-1].data.date)),H=`__branch__${p}`;if(A.push({id:H,name:`— ${p.toUpperCase()} —`,start:y,end:D,progress:0,dependencies:[],custom_class:`branch-header-${p}`}),C.add(H),!I.has(p))for(const N of m){const q=B(N);A.push(q),C.add(q.id)}}for(const p of A)p.dependencies=(p.dependencies||[]).filter(m=>C.has(m)).join(",");const ot=A.map(p=>+p.start),ht=A.map(p=>+p.end),ft=ot.length?new Date(Math.min(...ot)):null,mt=ht.length?new Date(Math.max(...ht)):null;return{tasks:A,minDate:ft,maxDate:mt,hiddenCount:Math.max(0,u.length-k.length)};function dt(p,m,y){const D=p.data||{};if(D.end_date)return new Date(D.end_date);if(D.duration)return wt(y,D.duration);if((D.tags||[]).includes("milestone"))return new Date(y.getTime()+900*1e3);if(D.status==="in-progress")return new Date;if(D.status==="done"){const H=m.get(p.id);if(H?.data?.date)return new Date(H.data.date)}return new Date(y.getTime()+1440*60*1e3)}function wt(p,m){if(typeof m=="number")return new Date(p.getTime()+m*60*1e3);const y=String(m).match(/^P(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?)?$/i);if(y){const D=parseInt(y[1]||0,10),H=parseInt(y[2]||0,10),N=parseInt(y[3]||0,10),q=parseInt(y[4]||0,10),bt=(((D*24+H)*60+N)*60+q)*1e3;return new Date(p.getTime()+bt)}return new Date(p.getTime()+3600*1e3)}},[n,t,l,w,v,I]);L.useEffect(()=>{if(!i.current)return;if(i.current.innerHTML="",!$||$.length===0){console.log("🎨 [GanttView] No tasks to render, skipping Frappe Gantt");return}console.log("🎨 [GanttView] Rendering Frappe Gantt:",{tasksCount:$.length,firstTask:$[0],containerExists:!!i.current});const u=M=>String(M??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");new gt(i.current,$,{view_mode:o,language:typeof s=="string"?s:"en",bar_height:24,padding:18,custom_popup_html:M=>`
        <div class="gantt-popup">
          <div class="title">${u(M.name)}</div>
          <div><b>Начало:</b> ${u(M._start?.toLocaleString?.()||M.start)}</div>
          <div><b>Окончание:</b> ${u(M._end?.toLocaleString?.()||M.end)}</div>
          <div><b>Прогресс:</b> ${String(M.progress||0)}%</div>
        </div>`,on_click:M=>{if(console.log("🖱️ [GanttView] on_click:",{taskId:M.id,taskName:M.name,customClass:M.custom_class,nodesCount:n.length}),(M.custom_class||"").includes("branch-header")){console.log("📌 [GanttView] Branch header clicked");const A=String(M.id).replace("__branch__",""),C=[...n].filter(B=>(B?.data?.branch||"")===A).sort((B,P)=>new Date(B.data.date)-new Date(P.data.date))[0];e&&C&&(console.log("✅ [GanttView] Opening sidebar for first task in branch:",C.id),e({type:"node",data:C.data}));return}const j=n.find(A=>A.id===M.id);console.log("🔍 [GanttView] Finding node:",{taskId:M.id,found:!!j}),e&&j?(console.log("✅ [GanttView] Opening sidebar for task:",j.id),e({type:"node",data:j.data})):console.warn("⚠️ [GanttView] Node not found or no onEntitySelect")}});const S=i.current.querySelector("svg");S&&(S.classList.add("gantt"),S.setAttribute("data-testid","gantt-svg")),St(i.current,$),it(i.current,a.current,W,R);const k=i.current,z=new ResizeObserver(()=>it(k,a.current,W,R));z.observe(k);let Y=0;const X=()=>{Y||(Y=requestAnimationFrame(()=>{it(k,a.current,W,R),Y=0}))};return k.addEventListener("scroll",X,{passive:!0}),()=>{k.removeEventListener("scroll",X),z.disconnect(),Y&&cancelAnimationFrame(Y),i.current&&(i.current.innerHTML="")}},[$,o,s,W,R]);const pt=L.useRef(n),_t=L.useRef(e);L.useEffect(()=>{pt.current=n,_t.current=e});const at=(u,S)=>{const k=new Set(u);return k.has(S)?k.delete(S):k.add(S),k},ut=l.size!==d.length||w.size!==h.length||v.size>0,rt=()=>{_(new Set(d)),T(new Set(h)),F(new Set),V(new Set)};return b.jsxs("div",{className:"gantt-container",children:[b.jsx("div",{className:"gantt-toolbar",children:b.jsxs("div",{className:"gantt-toolbar-row",children:[b.jsxs("div",{className:"gantt-seg",children:[b.jsx("span",{className:"seg-label",children:"Scale"}),["Day","Week","Month"].map(u=>b.jsx("button",{onClick:()=>r(u),className:`seg-btn ${o===u?"active":""}`,title:`Scale: ${u}`,children:u},u))]}),b.jsxs("div",{className:"gantt-seg",children:[b.jsx("span",{className:"seg-label",children:"Branch"}),d.map(u=>b.jsxs("label",{className:"chk",children:[b.jsx("input",{type:"checkbox",checked:l.has(u),onChange:()=>_(at(l,u))}),b.jsx("span",{children:u})]},u))]}),b.jsxs("div",{className:"gantt-seg",children:[b.jsx("span",{className:"seg-label",children:"Status"}),h.map(u=>b.jsxs("label",{className:"chk",children:[b.jsx("input",{type:"checkbox",checked:w.has(u),onChange:()=>T(at(w,u))}),b.jsx("span",{children:u})]},u))]}),b.jsxs("div",{className:"gantt-seg",style:{alignItems:"flex-start"},children:[b.jsx("span",{className:"seg-label",children:"Tags"}),b.jsx("div",{className:"tags-wrap",children:g.map(u=>b.jsxs("label",{className:`chk tag ${v.has(u)?"on":""}`,"data-testid":`tag-chip-${u}`,children:[b.jsx("input",{type:"checkbox",checked:v.has(u),onChange:()=>F(S=>{const k=new Set(S);return k.has(u)?k.delete(u):k.add(u),k})}),b.jsx("span",{children:u})]},u))})]}),b.jsxs("div",{className:"gantt-seg",children:[b.jsx("button",{className:`seg-btn reset ${ut?"active":""}`,onClick:rt,title:"Сбросить все фильтры и развороты",children:"Reset all"}),nt>0&&b.jsxs("span",{className:"hidden-badge","data-testid":"hidden-badge",title:"Скрытые задачи из‑за фильтров (клик = Reset all)",onClick:rt,children:[nt," hidden"]})]})]})}),b.jsx("div",{ref:i,className:"gantt-root",style:{height:Math.min(140+$.length*32,1200),maxHeight:"80vh",overflow:"auto"}}),b.jsx("div",{ref:a,className:"today-marker"})]})}function ct(n,t){const e=["main","debug","experiment"],s=e.indexOf(n),i=e.indexOf(t);return(s===-1?99:s)-(i===-1?99:i)||n.localeCompare(t)}function it(n,t,e,s){if(!n||!t||!e||!s)return;const i=n.querySelector("svg");if(!i)return;const a=i.getBoundingClientRect().width,r=(new Date-e)/(s-e);if(r<0||r>1||!isFinite(r)){t.style.display="none";return}t.style.display="block";const d=r*a-n.scrollLeft;t.style.left=`${d}px`,t.style.top=`${n.getBoundingClientRect().top}px`,t.style.height=`${i.getBoundingClientRect().height}px`}function St(n,t){const e=new Set(t.filter(o=>(o.custom_class||"").includes("milestone")).map(o=>o.id)),s=()=>{n.querySelectorAll(".bar-wrapper").forEach(o=>{const r=o.getAttribute("data-id");e.has(r)&&o.classList.add("milestone")})};requestAnimationFrame(s);const i=n.querySelector("svg"),a=new MutationObserver(s);i&&a.observe(i,{childList:!0,subtree:!0}),setTimeout(()=>a.disconnect(),500)}export{Yt as default};
