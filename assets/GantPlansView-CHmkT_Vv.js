import{r,j as s}from"./index-BSUL8Hu_.js";import R from"./GanttView-Ff8B2P5s.js";function B({onEntitySelect:g,locale:F="en"}){console.log("[GantPlansView] üîÑ Component rendering/mounting");const[u,x]=r.useState([]),[i,w]=r.useState(null),[A,v]=r.useState(!0),[S,G]=r.useState(null),[y,C]=r.useState(new Set),[$,m]=r.useState(!1),[o,j]=r.useState({title:"",owner:"argus-team",start_date:new Date().toISOString().split("T")[0],due_date:new Date(Date.now()+10080*60*1e3).toISOString().split("T")[0]}),[P,_]=r.useState(!1),T=(e,t)=>t.id?String(t.id):[e,t.title].filter(Boolean).join("::").normalize("NFKC").replace(/\s+/g," ").trim(),D=e=>{const t=e?.subtasks;return Array.isArray(t)?(t.length>0&&e.title?.includes("—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å")&&console.log("[getSubtasks] Task with subtasks:",e.title,"count:",t.length),t):t&&typeof t=="object"?(console.warn("[getSubtasks] Converting object subtasks to array:",e.title),Object.values(t)):[]};r.useEffect(()=>{(async()=>{try{v(!0);const t=await fetch("http://localhost:5006/api/gant/plans");if(!t.ok)throw new Error(`API error: ${t.status}`);const l=await t.json();console.log("[GantPlansView] Loaded plans from API:",l.plans?.length||0,"plans"),l.plans?.forEach(n=>console.log(`  - ${n.id}: ${n.title}`)),x(l.plans||[]),l.plans&&l.plans.length>0&&!i&&(console.log("[GantPlansView] Auto-selecting first plan:",l.plans[0].id),w(l.plans[0].id))}catch(t){console.error("Failed to load Gant plans:",t),G(t.message)}finally{v(!1)}})()},[]);const E=async()=>{if(o.title.trim()){_(!0);try{const e=await fetch("http://localhost:5006/api/gant/plans",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:o.title.trim(),owner:o.owner||"argus-team",start_date:o.start_date,due_date:o.due_date})});if(!e.ok){const n=await e.json();throw new Error(n.error||`API error: ${e.status}`)}const t=await e.json();console.log("[GantPlansView] Created plan:",t);const l=await fetch("http://localhost:5006/api/gant/plans/aggregate");if(l.ok){const n=await l.json();x(n.plans||[]),t.plan?.id&&w(t.plan.id)}m(!1),j({title:"",owner:"argus-team",start_date:new Date().toISOString().split("T")[0],due_date:new Date(Date.now()+10080*60*1e3).toISOString().split("T")[0]})}catch(e){console.error("Failed to create plan:",e),alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞: ${e.message}`)}finally{_(!1)}}};r.useEffect(()=>{if(!i)return;const e=setInterval(async()=>{try{const t=await fetch("http://localhost:5006/api/gant/plans");if(t.ok){const l=await t.json();x(l.plans||[])}}catch(t){console.error("Failed to update plans:",t)}},5e3);return()=>clearInterval(e)},[i]),r.useEffect(()=>{if(!i||!u.length)return;const e=u.find(n=>n.id===i);if(!e)return;const t=[],l=(n,a=null)=>{const h=T(a,n),c=D(n);c.length>0&&(n.title?.includes("—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å")&&console.log("[findTasksWithSubtasks] Found task with subtasks:",{title:n.title,taskId:h,subtasksCount:c.length,parentId:a}),t.push(h),c.forEach(p=>l(p,h)))};(e.tasks||[]).forEach(n=>l(n,null)),t.length>0?(console.log("[GantPlansView] Auto-expanding tasks:",t),C(new Set(t))):console.warn("[GantPlansView] ‚ö†Ô∏è No tasks with subtasks found!")},[i,u]);const V=e=>{if(!e||e.type!=="node"){g&&g(e);return}const t=e.data;if(!t){g&&g(e);return}if(t.hasSubtasks&&t.id){C(l=>{const n=new Set(l);return n.has(t.id)?n.delete(t.id):n.add(t.id),n});return}g&&g(e)},{nodes:I,edges:O}=r.useMemo(()=>{if(!i)return{nodes:[],edges:[]};const e=u.find(a=>a.id===i);if(!e)return{nodes:[],edges:[]};const t=[],l=[],n=(a,h=null,c=0)=>{const p=T(h,a),b=D(a),f=b.length>0,N=y.has(p);f&&a.title?.includes("—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å")&&console.log("[processTask] Rendering task with subtasks:",{title:a.title,taskId:p,subtasksCount:b.length,hasSubtasks:f,isExpanded:N,level:c});const L=f?N?"‚ñº ":"‚ñ∂ ":"",M=c>0?"  ".repeat(c)+"‚îî‚îÄ ":"";if(t.push({id:p,data:{id:p,label:`${M}${L}${a.title}`,date:a.start||a.start_date,end_date:a.end||a.due_date,status:a.status||"planned",branch:e.branch||"argus",tags:["gant-plan",e.id,...f?["has-subtasks"]:[],...c>0?["subtask"]:[]],duration:a.duration_hours||a.duration_days*24*60||null,progress:a.progress||0,hasSubtasks:f,parentTaskId:h}}),a.depends_on&&Array.isArray(a.depends_on))for(const k of a.depends_on)l.push({source:k,target:p,data:{linkType:"blocks",type:"blocks"}});h&&c>0&&l.push({source:h,target:p,data:{linkType:"parent",type:"parent"}}),f&&N&&b.forEach(k=>n(k,p,c+1))};for(const a of e.tasks||[])n(a,null,0);for(const a of e.milestones||[])t.push({id:`milestone-${a.date}`,data:{label:`‚¨• ${a.title}`,date:a.date,status:new Date(a.date)<=new Date?"done":"planned",branch:e.branch||"argus",tags:["milestone","gant-plan",e.id]}});return{nodes:t,edges:l}},[i,u,y]);if(A)return s.jsxs("div",{className:"gant-plans-loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("p",{children:"Loading Gant plans..."})]});if(S)return s.jsxs("div",{className:"gant-plans-error",children:[s.jsx("h3",{children:"‚ö†Ô∏è Failed to load plans"}),s.jsx("p",{children:S}),s.jsx("button",{onClick:()=>window.location.reload(),children:"Retry"})]});if(u.length===0)return s.jsxs("div",{className:"gant-plans-empty",children:[s.jsx("h3",{children:"üìã No Gant plans found"}),s.jsxs("p",{children:["Create plans in ",s.jsx("code",{children:"data/gant/plans.md"})]})]});const d=u.find(e=>e.id===i);return s.jsxs("div",{className:"gant-plans-container",children:[s.jsxs("div",{className:"gant-plans-header",children:[s.jsxs("div",{className:"plan-selector",children:[s.jsx("label",{htmlFor:"plan-select",children:"Plan:"}),s.jsx("select",{id:"plan-select",value:i||"",onChange:e=>w(e.target.value),className:"plan-dropdown",children:u.map(e=>s.jsx("option",{value:e.id,children:e.title},e.id))}),s.jsx("button",{className:"add-plan-btn",onClick:()=>m(!0),title:"–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–Ω",children:"+"})]}),d&&s.jsxs("div",{className:"plan-info",children:[s.jsx("span",{className:"plan-owner",children:d.owner}),d.timeline&&s.jsxs("span",{className:"plan-timeline",children:[new Date(d.timeline.start_date).toLocaleDateString()," ‚Üí"," ",new Date(d.timeline.due_date).toLocaleDateString()]})]})]}),d&&d.tasks?.length>0&&s.jsx("div",{className:"plan-progress-summary",children:d.tasks.map(e=>s.jsxs("div",{className:"task-progress-chip",children:[s.jsx("div",{className:`status-indicator status-${e.status}`}),s.jsx("span",{className:"task-title",children:e.title}),s.jsxs("span",{className:"task-progress",children:[Math.round((e.progress||0)*100),"%"]})]},e.id))}),I.length>0?s.jsx(R,{nodes:I,edges:O,onEntitySelect:V,locale:F}):s.jsx("div",{className:"gant-plans-empty",children:s.jsx("p",{children:"No tasks in selected plan"})}),d?.notes&&s.jsxs("div",{className:"plan-notes",children:[s.jsx("h4",{children:"Plan Notes"}),s.jsx("pre",{children:d.notes})]}),$&&s.jsx("div",{className:"modal-overlay",onClick:()=>m(!1),children:s.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:"modal-header",children:[s.jsx("h3",{children:"–ù–æ–≤—ã–π –ø–ª–∞–Ω"}),s.jsx("button",{className:"modal-close",onClick:()=>m(!1),children:"√ó"})]}),s.jsxs("div",{className:"modal-body",children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{htmlFor:"plan-title",children:"–ù–∞–∑–≤–∞–Ω–∏–µ"}),s.jsx("input",{id:"plan-title",type:"text",value:o.title,onChange:e=>j({...o,title:e.target.value}),placeholder:"–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞...",autoFocus:!0})]}),s.jsxs("div",{className:"form-group",children:[s.jsx("label",{htmlFor:"plan-owner",children:"–í–ª–∞–¥–µ–ª–µ—Ü"}),s.jsx("input",{id:"plan-owner",type:"text",value:o.owner,onChange:e=>j({...o,owner:e.target.value}),placeholder:"argus-team"})]}),s.jsxs("div",{className:"form-row",children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{htmlFor:"plan-start",children:"–ù–∞—á–∞–ª–æ"}),s.jsx("input",{id:"plan-start",type:"date",value:o.start_date,onChange:e=>j({...o,start_date:e.target.value})})]}),s.jsxs("div",{className:"form-group",children:[s.jsx("label",{htmlFor:"plan-due",children:"–î–µ–¥–ª–∞–π–Ω"}),s.jsx("input",{id:"plan-due",type:"date",value:o.due_date,onChange:e=>j({...o,due_date:e.target.value})})]})]})]}),s.jsxs("div",{className:"modal-footer",children:[s.jsx("button",{className:"btn-cancel",onClick:()=>m(!1),children:"–û—Ç–º–µ–Ω–∞"}),s.jsx("button",{className:"btn-create",onClick:E,disabled:P||!o.title.trim(),children:P?"–°–æ–∑–¥–∞–Ω–∏–µ...":"–°–æ–∑–¥–∞—Ç—å"})]})]})})]})}export{B as default};
